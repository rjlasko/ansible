---
## ------------------------------------- ##
## Create & install base virtual machine ##
## ------------------------------------- ##

- name: install packages for Ansible libvirt support
  become: true
  package:
    name: python-libvirt
    state: present

- name: List active VMs
  virt:
    command: list_vms
  register: libvirt_active_vms

- name: Handle active VM
  when: libvirt_vm.name | mandatory in libvirt_active_vms.list_vms
  block:
    - name: fail unless force
      when: libvirt_vm.force | default(false) == false
      fail:
        msg: "{{ libvirt_vm.name }} already exists. Override with 'force'"

    - name: "shutdown VM: {{ libvirt_vm.name }}"
      virt:
        command: shutdown
        name: "{{ libvirt_vm.name }}"

    - name: "waiting for shutdown: {{ libvirt_vm.name }}"
      virt:
        name: "{{ libvirt_vm.name }}"
        command: status
      register: libvirt_vm_status
      until: libvirt_vm_status.status == 'shutdown'
      retries: 1500
      delay: 5

    - name: "erase VM: {{ libvirt_vm.name }}"
      virt:
        name: "{{ libvirt_vm.name }}"
        command: undefine

    - name: "delete VM volume: {{ libvirt_vm.name }}"
      shell: virsh vol-delete --pool default "$(virsh vol-list --pool default | grep {{ libvirt_vm.name }} | awk '{print $1}')"


- name: Create VM with cleanup
  block:
    - name: create temporary staging directory
      tempfile:
        state: directory
      register: vm_staging_dir

    - name: build virt-install arguments
      set_fact:
        virt_install_cmd: virt-install
        virt_install_name: "--name={{ libvirt_vm.name | mandatory }}"
        virt_install_given_args: "{{ libvirt_vm.virt_install_args | mandatory }}"
        virt_install_location: "--location={{ libvirt_vm.location | mandatory}}"
        virt_install_initrd_inject: ''

    - name: handle preseed
      when: libvirt_vm.preseed is defined
      block:
        - name: populate preseed template
          include_role:
            name: envsubst
          vars:
            envsubst:
              src: "{{ libvirt_vm.preseed.src | mandatory }}"
              dest: "{{ vm_staging_dir.path }}/preseed.cfg"
              env_vars: "{{ libvirt_vm.preseed.env_vars | default(omit) }}"
              group: "{{ libvirt_vm.preseed.group | default(omit) }}"
              mode: "{{ libvirt_vm.preseed.mode | default(omit) }}"
              owner: "{{ libvirt_vm.preseed.owner | default(omit) }}"

        - name: build virt-install arguments - initrd-inject
          set_fact:
            virt_install_initrd_inject: "--initrd-inject={{ vm_staging_dir.path }}/preseed.cfg"

    - name: create new VM
      become: true
      command:
        argv: "{{ [virt_install_cmd] + [virt_install_name] + virt_install_given_args + [virt_install_location] + [virt_install_initrd_inject] }}"

  always:
    - name: remove staging directory
      file:
        path: "{{ vm_staging_dir.path }}"
        state: absent
