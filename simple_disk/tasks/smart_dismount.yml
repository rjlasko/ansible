---
## ------------------------------------------------------------------------- ##
## Dismounts the given simple disk if being rebuilt or its mount is changing ##
## ------------------------------------------------------------------------- ##

- name: get UUID of expected device partition
  become: true
  command: blkid -o value -s UUID {{ simple_disk.dev }}-part1
  register: blkid_dev_partition_uuid

- set_fact:
    partition_uuid: "{{ blkid_dev_partition_uuid.stdout }}"

- name: mounts by mountpoint
  set_fact:
    by_mountpoint: "{{ by_mountpoint | default({}) | combine( {item.mount: item} ) }}"
  with_items:
    - "{{ ansible_facts.mounts }}"

- name: unmount by mountpoint, if exists
  when: >
    simple_disk.mount in by_mountpoint
    and (
      (simple_disk.rebuild | default(false))
      or
      by_mountpoint[simple_disk.mount].uuid != partition_uuid
    )
  mount:
    path: "{{ simple_disk.mount }}"
    state: absent

- name: mounts by UUID
  set_fact:
    by_uuid: "{{ by_uuid | default({}) | combine( {item.uuid: item} ) }}"
  with_items:
    - "{{ ansible_facts.mounts }}"

- name: unmount device partition, if mountpoint is changing
  when: >
    partition_uuid in by_uuid
    and
    by_uuid[partition_uuid].mount != simple_disk.mount
  mount:
    path: "{{ by_uuid[partition_uuid].mount }}"
    state: absent

- name: update ansible_facts for mounts
  setup:
    gather_subset:
      - mounts
