---
## ---------------------------------- ##
## Create libvirt pool if not defined ##
## ---------------------------------- ##

- name: get listing of defined pools
  shell: virsh pool-list --all | awk '{print $1}' | tail -n+3
  register: initial_libvirt_pool_listing

- name: create pool directory navigable by user 'libvirt-qemu'
  when: initial_libvirt_pool_listing.stdout is not search(libvirt_pool.name)
  file:
    path: "{{ libvirt_pool.path | mandatory }}"
    state: directory
    mode: o=rx
    recurse: true

- name: set pool directory read-write by libvirt users 
  when: initial_libvirt_pool_listing.stdout is not search(libvirt_pool.name)
  file:
    path: "{{ libvirt_pool.path }}"
    state: directory
    mode: g=rwx,o-rwx
    recurse: false
    group: libvirt-qemu

- name: define pool
  when: initial_libvirt_pool_listing.stdout is not search(libvirt_pool.name)
  command: "virsh pool-define-as {{ libvirt_pool.name }} dir - - - - {{ libvirt_pool.path }}"

- name: start pool
  command: "virsh pool-autostart {{ libvirt_pool.name }}"

- command: virsh pool-list --all
  register: virsh_pool_listing

- debug: msg="{{ virsh_pool_listing.stdout_lines }}"
