---
## ---------------------------------- ##
## Adds a user to the list of sudoers ##
## ---------------------------------- ##
# TODO: add to "admin" groups when needed on OSx/BSD
# https://stackoverflow.com/questions/33359404/ansible-best-practice-for-maintaining-list-of-sudoers

- ansible.builtin.package:
    name: sudo
    state: present

# determine default group with sudo privileges
- name: get all groups
  ansible.builtin.shell: getent group | awk -F":" '{print $1}'
  register: getent_groups

- name: find default sudoers group
  when: item in getent_groups.stdout_lines
  # XXX: in ascending order of precedence
  # see: https://wiki.archlinux.org/index.php/Sudo#Example_entries
  with_items:
    - sudo
    - wheel
  ansible.builtin.set_fact:
    default_sudoers_group: "{{ item }}"

- name: find preexisting custom sudoers files
  find:
    paths: "/etc/sudoers.d"
    patterns: "custom_*"
  register: find_custom_sudoers

- name: reset custom sudoers files
  when: find_custom_sudoers.files
  with_items: find_custom_sudoers.files
  file:
    path: "{{ item.path }}"
    state: absent

- name: add custom sudoers file
  community.general.sudoers:
    name: custom_nologin
    state: present
    group: "{{ default_sudoers_group }}"
    commands: ALL
    nopassword: true
