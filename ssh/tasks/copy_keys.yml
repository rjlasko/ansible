---
## ---------------------------------------- ##
## Copies given SSH private and public keys ##
## ---------------------------------------- ##

- name: ensure key directory exists
  file:
    path: ~/.ssh
    state: directory
    mode: u=rwx,go-rwx

- name: copy public key
  copy:
    src: "{{ ssh.copy_keys.pub_key_file | mandatory }}"
    dest: "~/.ssh/id_{{ ssh.key_type | mandatory }}.pub"
    mode: u=rw,g=r,o=r
    decrypt: "{{ ssh.copy_keys.decrypt | default(omit) }}"
    force: "{{ ssh.copy_keys.force | default(true) }}"

- name: get username (in case of using 'su')
  command: whoami
  register: whoami_result

- name: get pubkey sans the comment
  shell: cat ~/.ssh/id_{{ ssh.key_type }}.pub | cut -d' ' -f1,2
  register: pub_key_no_comment

- name: update pubkey comment
  lineinfile:
    path: "~/.ssh/id_{{ ssh.key_type }}.pub"
    regexp: ".*"
    line: "{{ pub_key_no_comment.stdout }} {{ whoami_result.stdout }}@{{ ansible_facts['hostname'] }}"
    state: present

- name: copy private key
  copy:
    src: "{{ ssh.copy_keys.pri_key_file | mandatory }}"
    dest: "~/.ssh/id_{{ ssh.key_type | mandatory }}"
    mode: u=rw,go-rwx
    decrypt: "{{ ssh.copy_keys.decrypt | default(omit) }}"
    force: "{{ ssh.copy_keys.force | default(true) }}"
