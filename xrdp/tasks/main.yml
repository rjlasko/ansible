---
## -------------------------------------------------------- ##
## This script seeks to automate the installation of a XRDP ##
## -------------------------------------------------------- ##
# https://wiki.archlinux.org/index.php/xrdp

# XXX: the current Debian package does not work with MacOS version of Microsoft Remote Desktop
- when: ansible_distribution != "Debian" and ansible_distribution_major_version is version_compare('10', '>=')
  fail:
    msg: "Only supports Debian 9. Found {{ ansible_distribution }} {{ ansible_distribution_version }} ({{ ansible_distribution_release }})"

# XXX: the installation from the v0.9.9 source is necessary to support a graphical feature
#      required by the MacOS version of the Microsoft Remote Desktop application
#      https://github.com/neutrinolabs/xrdp/pull/1235

- name: install from source
  become: true
  block:
    - import_tasks: from_source.yml
    ### update configuration and service ###

    # TODO: additional XRDP configuration
    # XXX: 'man xrdp.ini', as in /etc/xrdp/xrdp.ini
    # XXX: 'man sesman.ini', as in /etc/xrdp/sesman.ini
    - name: disable thinclient_drives
      lineinfile:
        dest: /etc/xrdp/xrdp.ini
        state: present
        regexp: '^#?;?allow_channels'
        line: 'allow_channels=false'

    # TODO: Generate certificate /etc/xrdp/{cert,key}.pem if you don't want to use the self-signed certificate

    # allow anybody to start X.
    # Necessary to run XRDP as a terminal server (Xorg).
    # default is 'console'
    - name: configure x11
      lineinfile:
        dest: /etc/X11/Xwrapper.config
        state: present
        regexp: '^allowed_users'
        line: 'allowed_users=anybody'

    - name: restart xrdp
      service:
        name: xrdp
        state: restarted
        enabled: true

    - name: restart xrdp-sesman
      service:
        name: xrdp-sesman
        state: restarted
        enabled: true

    - name: daemon_reload
      systemd:
        daemon_reload: true
  vars:
    xrdp_version: 0.9.9
    xorg_xrdp_version: 0.2.9
