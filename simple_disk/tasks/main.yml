---
## ------------------------------------------ ##
## Perform simple disk partition/format/mount ##
## ------------------------------------------ ##

- set_fact:
    simple_disk_fstypes: "{{ simple_disks | selectattr('fstype', 'defined') | map(attribute='fstype') | unique | list }}"
    simple_disk_rebuild: "{{ simple_disks | selectattr('rebuild', 'defined') | map(attribute='rebuild') | unique | list }}"

- name: install support for XFS
  when: '"xfs" in simple_disk_fstypes'
  package:
    name: xfsprogs

- name: install support for parted
  when: simple_disk_rebuild is any
  package:
    name: parted

- name: dismount disks being updated or rebuilt
  loop: "{{ simple_disks | default([]) }}"
  loop_control:
    loop_var: simple_disk_item
  include: smart_dismount.yml
  vars:
    simple_disk: "{{ simple_disk_item }}"

- name: setup disks
  loop: "{{ simple_disks | default([]) }}"
  loop_control:
    loop_var: simple_disk_item
  include: single_disk.yml
  vars:
    simple_disk: "{{ simple_disk_item }}"
