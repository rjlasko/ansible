---
## -------------------------- ##
## Build or Restore Container ##
## -------------------------- ##

- name: check invalid create mode
  when: lxc.container.create_mode | mandatory not in ['skip', 'build']
  fail:
    msg: "invalid lxc.container.create_mode: {{ lxc.container.create_mode }}"

- name: handle create container
  when: lxc.container.create_mode == 'build'
  block:

    - name: define custom container configuration
      include_tasks: container_config.yml

    - name: merge user custom config
      when: lxc.container.config is defined
      set_fact:
        lxc_custom_config: "{{ ( lxc.container.config ) | combine(lxc_custom_config | default({}), recursive=True) }}"

    - name: clear pre-existing container
      lxd_container:
        name: "{{ lxc.container.name | mandatory}}"
        state: absent
        # TODO: do this only if trying without it fails
        force_stop: true

    - name: initialize host directories for LXC container usage
      when: lxc.file_drop is defined
      become: true
      # XXX: 'include_role' didn't seem to like 'become'
      import_role:
        name: file_drop
      vars:
        file_drop: "{{ lxc.file_drop }}"

    - name: create & (re)start container
      community.general.lxd_container:
        name: "{{ lxc.container.name }}"
        type: "{{ lxc.container.type | default('container') }}"
        state: restarted
        source:
          server: "{{ lxc.container.server | default('https://images.linuxcontainers.org') }}"
          alias: "{{ lxc.container.alias | mandatory }}"
          # 'simplstreams' seems more reliable than the default protocol 'lxd'
          protocol: "{{ lxc.container.protocol | default('simplestreams') }}"
          type: image
          mode: pull
        config: "{{ lxc_custom_config | default(omit) }}"
        devices: "{{ lxc.container.devices | default(omit) }}"
        profiles: "{{ lxc.container.profiles | default(omit) }}"
        wait_for_ipv4_addresses: true
        timeout: 600

- name: "wait for {{ lxc.container.name }} to respond with SSHd"
  wait_for:
    host: "{{ lxc.container.dns_address | mandatory }}"
    port: 22
