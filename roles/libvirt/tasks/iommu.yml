---
## ------------------------------------------------------ ##
## Enables IOMMU to support PCIe passthrough to guest VMs ##
## ------------------------------------------------------ ##

- name: detect host hardware supports iommu
  command: grep -E '^flags.*(svm|vmx)' /proc/cpuinfo

- name: detect Intel architecture
  when: ansible_facts.processor[1] == 'GenuineIntel'
  set_fact:
    arch_iommu: intel_iommu
- name: detect AMD architecture
  when: ansible_facts.processor[1] == 'AuthenticAMD'
  set_fact:
    arch_iommu: amd_iommu

- name: detect unsupported architecture
  when: arch_iommu is not defined
  fail:
    msg: "Only supports Intel and AMD distributions. Found: {{ ansible_facts.processor[1] }}"

- name: IOMMU via GRUB
  block:
    - set_fact:
        grub_filepath: /etc/default/grub

    - name: check if GRUB is the boot manager
      stat:
        path: "{{ grub_filepath }}"
      register: grub_file

    - name: when GRUB is the boot manager
      when: grub_file.stat.exists
      include_tasks: iommu_grub.yml

- name: IOMMU via systemd-boot
  when: not grub_file.stat.exists
  block:
    - name: check if kernelstub command exists
      command: kernelstub --help
      ignore_errors: true
      register: kernelstub

    - name: when kernelstub exists
      when: kernelstub.rc == 0
      include_tasks: iommu_systemd_boot.yml

- when: not (grub_file.stat.exists or kernelstub.rc == 0)
  fail:
    msg: failed to setup iommu
