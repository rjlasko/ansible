---
## ----------------- ##
## Shutdown Guest VM ##
## ----------------- ##

- name: "detect VM state before attempt restart: {{ libvirt.vm.name }}"
  community.libvirt.virt:
    command: status
    name: "{{ libvirt.vm.name }}"
  register: libvirt_vm_status

- name: error out if VM is in unacceptable state
  when: >
    libvirt_vm_status.status != 'running'
    and
    libvirt_vm_status.status != 'shutdown'
  ansible.builtin.fail:
    msg: "Cannot shutdown {{ libvirt.vm.name }} from state: {{ libvirt_vm_status.status }}"

- name: shutdown from running state
  when: libvirt_vm_status.status == 'running'
  block:
    - name: Pause for manual indication if specified
      when: libvirt.vm.check_manual | default(false)
      ansible.builtin.pause:
        prompt: "Continue when ready for shutdown"

    - name: shutdown VM
      community.libvirt.virt:
        # XXX: Windows guests need to have the VirtIO Guest Tools installed
        # Linux guests should shutdown cleanly without any special attention
        command: shutdown
        name: "{{ libvirt.vm.name }}"

    - name: "waiting for shutdown: {{ libvirt.vm.name }}"
      community.libvirt.virt:
        command: status
        name: "{{ libvirt.vm.name }}"
      register: libvirt_vm_status
      until: libvirt_vm_status.status == 'shutdown'
      # check for desired status for 5 minutes
      delay: 3
      retries: 100
