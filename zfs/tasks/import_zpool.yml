---
## -------------------------------- ##
## Imports ZFS pool if not present ##
## -------------------------------- ##

# TODO: a "zpool" ansible module is forthcoming
# https://github.com/ansible/ansible/pull/43690

- name: get current zpools
  shell: zpool list | awk '{print $1}' | tail -n+2
  register: initial_zpool_listing

# XXX: consider.... for any zpool previously existing, unimport, and then reimport

- name: import zpool
  when: initial_zpool_listing.stdout is not search(zfs_pool)
  command: "zpool import -d /dev/disk/by-id -f {{ zfs_pool }}"

# XXX: it may be the case that permanent mounting needs to be triggered
# - name: trigger zpool import scan & permanent mount
#   when: >
#     ansible_facts['distribution'] != 'Ubuntu' and
#     ansible_facts['distribution'] != 'Pop!_OS'
#   service:
#     name: zfs-import-scan
#     state: restarted
#     enabled: true
