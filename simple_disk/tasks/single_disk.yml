---
## ------------------------------------------- ##
## Partition (single) a disk, format and mount ##
## ------------------------------------------- ##

- set_fact:
    simple_disk_rebuild: "{{ simple_disk.rebuild | default(false) }}"
    simple_partition_dev: "{{ simple_disk.dev }}-part1"

- name: rebuild disk with a single partition
  when: simple_disk_rebuild
  block:
    - name: "Read information from device: {{ simple_disk.dev | mandatory }}"
      parted:
        device: "{{ simple_disk.dev }}"
        unit: MiB
      register: sdb_info

    - name: "Remove all partitions from device: {{ simple_disk.dev }}"
      loop: "{{ sdb_info.partitions }}"
      parted:
        device: "{{ simple_disk.dev }}"
        number: "{{ item.num }}"
        state: absent

    - name: "Partition device: {{ simple_disk.dev }}"
      parted:
        device: "{{ simple_disk.dev }}"
        number: 1
        state: present

- name: "Format {{ simple_partition_dev }} as {{ simple_disk.fstype | mandatory }}"
  when: simple_disk_rebuild or simple_disk.format | default(false)
  filesystem:
    dev: "{{ simple_partition_dev }}"
    fstype: "{{ simple_disk.fstype }}"
    force: true

- name: "verify {{ simple_partition_dev }} has filesystem type: {{ simple_disk.fstype }}"
  become: true
  command: blkid -o value -s TYPE {{ simple_disk.dev }}-part1
  register: blkid_dev_partition
  failed_when: blkid_dev_partition.stdout != simple_disk.fstype

- name: "Mount {{ simple_partition_dev }} to {{ simple_disk.mount | mandatory }}"
  mount:
    src: "{{ simple_partition_dev }}"
    path: "{{ simple_disk.mount }}"
    fstype: "{{ simple_disk.fstype }}"
    state: mounted
