---
## -------------------------- ##
## Build or Restore Instance ##
## -------------------------- ##

- name: check invalid create mode
  when: lxd.instance.create_mode | mandatory not in ['skip', 'build']
  fail:
    msg: "invalid lxd.instance.create_mode: {{ lxd.instance.create_mode }}"

- name: handle create instance
  when: lxd.instance.create_mode == 'build'
  block:

    - name: define custom instance configuration
      include_tasks: instance_config.yml

    - name: merge user custom config
      when: lxd.instance.config is defined
      set_fact:
        lxd_custom_config: "{{ ( lxd.instance.config ) | combine(lxd_custom_config | default({}), recursive=True) }}"

    - name: clear pre-existing instance
      community.general.lxd_container:
        name: "{{ lxd.instance.name | mandatory}}"
        state: absent
        # TODO: do this only if trying without it fails
        force_stop: true

    - name: initialize host directories for LXD instance usage
      when: lxd.file_drop is defined
      become: true
      # XXX: 'include_role' didn't seem to like 'become'
      import_role:
        name: file_drop
      vars:
        file_drop: "{{ lxd.file_drop }}"

    - name: create & (re)start instance
      community.general.lxd_container:
        name: "{{ lxd.instance.name }}"
        type: "{{ lxd.instance.type | default(omit) }}"
        state: restarted
        source:
          server: "{{ lxd.instance.server | default('https://images.linuxcontainers.org') }}"
          alias: "{{ lxd.instance.alias | mandatory }}"
          # 'simplestreams' seems more reliable than the default protocol 'lxd'
          protocol: "{{ lxd.instance.protocol | default('simplestreams') }}"
          type: image
          mode: pull
        config: "{{ lxd_custom_config | default(omit) }}"
        devices: "{{ lxd.instance.devices | default(omit) }}"
        profiles: "{{ lxd.instance.profiles | default(omit) }}"
        wait_for_ipv4_addresses: true
        timeout: 600

- name: "wait for {{ lxd.instance.name }} to respond with SSHd"
  wait_for:
    host: "{{ lxd.instance.dns_address | mandatory }}"
    port: 22
