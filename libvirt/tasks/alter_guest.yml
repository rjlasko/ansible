---
## ------------------------------------- ##
## Alter a VM via its XML representation ##
## ------------------------------------- ##

- name: shutdown VM
  include: shutdown_guest.yml

- name: alter cpu topology and affinity
  when: libvirt_vm.alter_domain.cpuset is defined
  include: alter_cpus.yml
  vars:
    libvirt_cpu: "{{ libvirt_vm.alter_domain.cpuset }}"

- name: attach disks
  when: libvirt_vm.alter_domain.disks is defined
  loop: "{{ libvirt_vm.alter_domain.disks }}"
  loop_control:
    loop_var: alter_domain_disk
  include: attach_disk.yml
  vars:
    libvirt_disk: "{{ alter_domain_disk }}"

- name: alter VM by XPath
  when: libvirt_vm.alter_domain.xpaths is defined
  block:
    - name: install lxml for python2
      when: ansible_python_version is version('3', '<')
      become: true
      package:
        name: python-lxml
        state: present

    - name: install lxml for python3
      when: ansible_python_version is version('3', '>=')
      become: true
      package:
        name: python3-lxml
        state: present

    - name: begin alter xml block
      block:
        - name: create temporary deferred domain XML
          tempfile:
            state: file
            suffix: deferred.xml
          register: temp_xml

        - name: alter xpaths
          loop: "{{ libvirt_vm.alter_domain.xpaths }}"
          loop_control:
            loop_var: alter_domain_xpath
          include: alter_xpath.yml
          vars:
            libvirt_xpath: "{{ alter_domain_xpath }}"
            libvirt_defered_xml: "{{ temp_xml.path }}"

      always:
        - name: remove deferred domain XML
          file:
            path: "{{ temp_xml.path }}"
            state: absent

# - fail:
#     msg: boom
