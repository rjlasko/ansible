---
## -------------------------------------------- ##
## Alter the topology and cpu affinity for a VM ##
## -------------------------------------------- ##

- command: cat /proc/cpuinfo
  register: proc_cpuinfo

- name: configure vcpu
  when: libvirt_cpu.vcpupin is defined
  block:
    - name: alter topology by XPath
      include: alter_domain_xpaths.yml
      vars:
        alter_domain_xpaths:
          - xpath: /domain/vcpu
            value: "{{ libvirt_cpu.vcpupin | length }}"
            defer: 'initial'
          - xpath: /domain/cpu/topology
            attribute: sockets
            value: '1'
            defer: true
          - xpath: /domain/cpu/topology
            attribute: dies
            value: '1'
            defer: true
          - xpath: /domain/cpu/topology
            attribute: cores
            value: "{{ ( (libvirt_cpu.vcpupin | length) / ansible_facts.processor_threads_per_core ) | round(0, 'ceil') | int }}"
            defer: true
          - xpath: /domain/cpu/topology
            attribute: threads
            value: "{{ ansible_facts.processor_threads_per_core }}"
            defer: 'apply'

    - name: pin vcpus
      loop: "{{ libvirt_cpu.vcpupin }}"
      loop_control:
        loop_var: vcpupin_cpuset
        index_var: vcpupin_idx
      command: "virsh vcpupin {{ libvirt.vm.name }} {{ vcpupin_idx }} {{ vcpupin_cpuset | asNative(proc_cpuinfo.stdout_lines) }} --config"

- name: configure iothread pinning
  when: libvirt_cpu.iothread is defined
  block:
    - name: add iothread id
      loop: "{{ libvirt_cpu.iothread }}"
      loop_control:
        index_var: iothread_idx
      command: "virsh iothreadadd {{ libvirt.vm.name }} {{ iothread_idx + 1 }} --config"

    - name: pin iothread
      loop: "{{ libvirt_cpu.iothread }}"
      loop_control:
        loop_var: iothread_cpuset
        index_var: iothread_idx
      command: "virsh iothreadpin {{ libvirt.vm.name }} {{ iothread_idx + 1 }} {{ iothread_cpuset | asNative(proc_cpuinfo.stdout_lines) }} --config"

- name: configure emulator emulator
  when: libvirt_cpu.emulator is defined
  block:
    - name: pin emulator
      command: "virsh emulatorpin {{ libvirt.vm.name }} {{ libvirt_cpu.emulator | asNative(proc_cpuinfo.stdout_lines) }} --config"
