---
## -------------------------------------------------------- ##
## This script seeks to automate the installation of Docker ##
## -------------------------------------------------------- ##

# XXX: is not compatible with libvirt bridge networking in the default configuration:
# https://serverfault.com/questions/963759/docker-breaks-libvirt-bridge-network
# https://serverfault.com/questions/948339/networking-between-kvm-vm-and-docker-container-on-same-host
# https://bbs.archlinux.org/viewtopic.php?id=233727
# https://www.reddit.com/r/linuxadmin/comments/7tlkve/libvirt_network_configuration_conflicts_with/

- when: ansible_distribution != "Debian"
  fail:
    msg: "Only supports Debian!"

- package:
    name: "{{ docker_dependencies }}"
  vars:
    docker_dependencies:
      - apt-transport-https
      - ca-certificates
      - gnupg2
      - software-properties-common

- apt_key:
    url: https://download.docker.com/linux/debian/gpg
    state: present

- command: apt-key fingerprint 0EBFCD88
  register: fingerprint_out

- debug: msg="{{ fingerprint_out.stdout_lines }}"

- apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
    state: present
    update_cache: yes

- package:
    name: "{{ docker_packages }}"
  vars:
    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io

- command: docker run hello-world
  register: dkr_out

- debug: msg="{{ dkr_out.stdout_lines }}"

- systemd:
    name: docker
    state: restarted
    enabled: yes

# install the latest officially released version of docker-compose
- name: query docker-compose version
  shell: git ls-remote --tags https://github.com/docker/compose.git | cut -f 2 | sort -t '/' -k 3 --version-sort | grep -v "rc" | grep -v "docs" | tail -n1 | sed 's:.*/::'
  register: docker_compose_version

- debug: msg="{{ docker_compose_version }}"

- get_url:
    url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version.stdout }}/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"
    dest: /usr/local/bin/docker-compose
    mode: u=rwx,g=rx
    group: docker
    force: yes

# grant user permissions to run Docker
- loop: "{{ docker_users | default([]) }}"
  user:
    name: "{{ item }}"
    groups: docker
    append: yes
