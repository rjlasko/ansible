---
## --------------------------------------------------------------- ##
## Automates the installation and setup of LXD hosts and instances ##
## --------------------------------------------------------------- ##

# XXX: https://github.com/lxc/lxd/tree/master/doc

- name: install LXD to the host
  when: lxd.host is defined
  ansible.builtin.include_tasks: host.yml

# XXX: externally add user to 'lxd' group
# TODO: where is the default backing storage located? ZFS dataset?
# TODO: permissions supporting running docker in LXC

- name: check invalid create mode
  loop: "{{ lxd.guests }}"
  loop_control:
    loop_var: lxd_guest
  ansible.builtin.assert:
    that: lxd_guest.create_mode in ['skip', 'build']
    quiet: true

- name: (re)build guests
  vars:
    lxd_guests: "{{ lxd.guests | selectattr('create_mode', 'eq', 'build') }}"
  when: lxd.guests is defined
  ansible.builtin.include_tasks: instance.yml

# TODO: https://lxd.readthedocs.io/en/latest/backup/#container-backup-and-restore

# XXX: adding the user to the user group 'lxd' enables root-like access to LXD
# this is similar in behavior with the `docker` group
