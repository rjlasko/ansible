---
## ------------------------------------- ##
## Install required packages as detected ##
## ------------------------------------- ##

- name: discover requested fstypes and rebuild requests
  ansible.builtin.set_fact:
    # fstypes can be indicated only on partitions
    simple_storage_fstypes: "{{
      simple_storage
      | selectattr('partitions', 'defined') | map(attribute='partitions')
      | selectattr('fstype', 'defined') | map(attribute='fstype')
      | unique }}"
    # rebuilding means wiping out all preexisting partitions on a given device or pool of devices
    simple_storage_repartitions: >
      {{ simple_storage | selectattr('rebuild', 'defined') | map(attribute='rebuild') | unique | list }}

- name: install support for XFS
  when: "xfs" in simple_storage_fstypes
  ansible.builtin.package:
    name: xfsprogs

- name: install support for btrfs
  when: "btrfs" in simple_storage_fstypes
  ansible.builtin.package:
    name: btrfs-progs

- name: install support for parted
  when: simple_storage_repartitions is any
  ansible.builtin.package:
    name: parted
