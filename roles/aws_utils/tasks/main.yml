---
## -------------------------------------------------- ##
## Installs common utilities for interacting with AWS ##
## -------------------------------------------------- ##

- assert:
    that: ansible_facts.system == 'Darwin'

- name: install awscli and included components
  block:
    - name: create temp directory to store download
      ansible.builtin.tempfile:
        state: directory
      register: awscli_tempdir

    - name: download AWS CLI
      ansible.builtin.get_url:
        url: "https://awscli.amazonaws.com/AWSCLIV2.pkg"
        dest: "{{ awscli_tempdir.path }}/awscli.pkg"
        mode: u=rwx,go-rwx
        force: true

    - name: install AWS CLI
      become: true
      ansible.builtin.command: "installer -pkg {{ awscli_tempdir.path }}/awscli.pkg -target /"
      changed_when: true

    - name: find aws_completer
      environment:
        PATH: "{{ aws_bin_path }}:{{ ansible_env.PATH }}"
      ansible.builtin.shell: command -v aws_completer
      changed_when: false
      register: aws_completer_filepath

    - name: "add aws completion to shell initialization script: {{ aws_completions_filepath }}"
      ansible.builtin.blockinfile:
        path: "{{ aws_completions_filepath }}"
        create: true
        marker: "# --- {mark} AWS Completions ---"
        block: "complete -C '{{ aws_completer_filepath.stdout }}' aws"
        state: present
        mode: u=rw,go=r

  always:
    - name: delete temporary directory
      ansible.builtin.file:
        path: "{{ awscli_tempdir.path }}"
        state: absent

- name: "copy {{ aws_config }}"
  ansible.builtin.copy:
    src: "{{ aws_config_src }}"
    dest: "{{ aws_config }}"
    mode: u=r,go-rwx

- name: unload any previously installed service
  community.general.launchd:
    name: "{{ aws_creds_launchd_service_name }}"
    enabled: true
    state: unloaded
  ignore_errors: true

- assert:
    that: aws_login_installation in ['pipx', 'none']

- when: aws_login_installation in ['pipx']
  block:
    - name: install gimme-aws-creds (pipx)
      when: aws_login_installation == 'pipx'
      ansible.builtin.include_role:
        name: pipx
      vars:
        pipx_packages: gimme-aws-creds

    - name: delete preexisting files created by this role
      with_items:
        - "{{ okta_aws_login_config }}"
        - "{{ aws_login_bin }}"
        - "{{ aws_credentials }}"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent

    - name: "generate from template: {{ okta_aws_login_config }}"
      ansible.builtin.template:
        src: okta_aws_login_config.ini.j2
        dest: "{{ okta_aws_login_config }}"
        mode: u=r,go-rwx

    - name: "generate from template: {{ aws_login_bin }}"
      ansible.builtin.template:
        src: aws-login.sh.j2
        dest: "{{ aws_login_bin }}"
        mode: u=rx,go-rwx

    - name: "generate from template: {{ aws_login_plist }}"
      ansible.builtin.template:
        src: aws_login.plist.xml.j2
        dest: "{{ aws_login_plist }}"
        mode: u=rw,go=r

    - name: Load, enable and start service
      community.general.launchd:
        name: "{{ aws_creds_launchd_service_name }}"
        enabled: true
        state: reloaded
