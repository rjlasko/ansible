---
## ---------------------- ##
## Sets up a crontab user ##
## ---------------------- ##

- name: install crontabs for given user
  become: true
  become_user: "{{ crontab_user_def.user | mandatory }}"
  block:
    - name: clear crontab
      when: crontab_user_def.reset | default(false)
      command: crontab -r
      ignore_errors: true

    - name: append to user crontab from file
      when: crontab_user_def.file is defined
      block:
        - name: create temporary cron file
          tempfile:
            state: directory
          register: crontab_staging_dir

        - name: stage provided crontab
          copy:
            src: "{{ crontab_user_def.file }}"
            dest: "{{ crontab_staging_dir.path }}/cron.tab"
            force: yes
        - command: crontab "{{ crontab_staging_dir.path }}/cron.tab"
      always:
        - name: remove staging directory
          file:
            path: "{{ crontab_staging_dir.path }}"
            state: absent

    - name: MAILTO
      cron:
        env: true
        name: MAILTO
        job: "{{ crontab_user_def.mailto | mandatory }}"

    - name: PATH
      when: crontab_user_def.path is defined
      cron:
        env: true
        insertafter: MAILTO
        name: PATH
        job: "{{ crontab_user_def.path }}"
