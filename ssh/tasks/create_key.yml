---
## ---------------- ##
## Creates SSH keys ##
## ---------------- ##

- name: glob for public keys
  find:
    paths: ~/.ssh
    patterns: '*.pub'
  register: file_glob_results

- name: create SSH key, if doesn't already exist
  when: >
    file_glob_results.matched < 1
    or
    ssh.replace_key | default(false)
  block:
    - name: get username (in case of using 'su')
      command: whoami
      register: whoami_result

    - name: set default SSH key type
      set_fact:
        key_type: "{{ ssh.key_type | default('ed25519') }}"

    - name: "Create ssh keys for '{{ whoami_result.stdout }}'"
      user:
        name: "{{ whoami_result.stdout }}"
        generate_ssh_key: yes
        ssh_key_file: "~/.ssh/id_{{ key_type }}"
        ssh_key_type: "{{ key_type }}"
        ssh_key_comment: "{{ whoami_result.stdout }}@{{ ansible_facts['hostname'] }}"
        state: present
        # prevent overwrite of existing keys
        force: "{{ ssh.replace_key | default(false) }}"
