---
## ------------- ##
## Installs java ##
## ------------- ##

- name: resolve system package names to install
  loop: "{{ java_versions }}"
  loop_control:
    loop_var: java_system_version
  set_fact:
    java_system_packages: "{{ java_system_packages + [ java_package_pattern[ansible_facts.os_family] | format(java_system_version) ] }}"

- when: ansible_facts.system == 'Darwin'
  block:
    - name: install java versions (MacOS)
      when: java_system_packages | length > 0
      community.general.homebrew_cask:
        name: "{{ java_system_packages }}"
        state: present

    - name: query for installed Java versions (MacOS)
      ansible.builtin.shell: set -o pipefail && /usr/libexec/java_home -V 2>&1 | awk '{$1=$1;print}' | grep -E '^([0-9]+)\.([0-9]+)\.([0-9]+)' | awk '{print $NF}'
      args:
        executable: bash
      register: java_homes_installed
      changed_when: false

    - set_fact:
        java_homes: "{{ java_homes + java_homes_installed.stdout_lines }}"

- when: ansible_facts.system == 'Linux'
  block:
    - name: "install java versions ({{ ansible_facts.os_family }} Linux)"
      when: java_system_packages | length > 0
      become: true
      ansible.builtin.package:
        name: "{{ java_system_packages }}"
        state: present

    - name: query for installed Java versions
      ansible.builtin.shell: set -o pipefail && update-alternatives --list java | sed 's#/bin.*##'
      args:
        executable: bash
      register: java_homes_installed
      changed_when: false

    - set_fact:
        java_homes: "{{ java_homes + java_homes_installed.stdout_lines }}"

- assert:
    that: java_homes | length > 0
