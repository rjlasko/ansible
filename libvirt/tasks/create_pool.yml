---
## ---------------------------------- ##
## Create libvirt pool if not defined ##
## ---------------------------------- ##

- name: get listing of defined pools
  shell: virsh pool-list --all | awk '{print $1}' | tail -n+3
  register: initial_libvirt_pool_listing

# TODO: currently does NOT support changing the location of an existing pool, such as 'default'.
# one possible issue here is that something like 'default' might need to always exist, and so a
# remove-add process might be more complicated than we want.
# the last time this needed to be addressed, manual invocation of `virsh pool-edit default` was used.

# FIXME: probably should fail if the pool paths are different

- name: create and/or set permissions pool directory read-write by libvirt users
  when: initial_libvirt_pool_listing.stdout is not search(libvirt_pool.name)
  file:
    path: "{{ libvirt_pool.path | mandatory }}"
    state: directory
    mode: u=rwx,g=rwx,o-rwx
    recurse: false
    owner: root
    group: libvirt-qemu

- name: define pool
  when: initial_libvirt_pool_listing.stdout is not search(libvirt_pool.name)
  command: "virsh pool-define-as {{ libvirt_pool.name }} dir - - - - {{ libvirt_pool.path }}"

- name: start pool
  command: "virsh pool-autostart {{ libvirt_pool.name }}"

# - command: virsh pool-list --all
#   register: virsh_pool_listing

# - debug: msg="{{ virsh_pool_listing.stdout_lines }}"
