---
## ---------------------------------------------- ##
## Authorizes SSH login with the given public key ##
## ---------------------------------------------- ##

- name: extract SSH key id
  shell: "echo {{ authorized_key | mandatory }} | awk '{print $3}'"
  register: key_id

- name: write authorized public key
  lineinfile:
    path: "~/.ssh/authorized_keys"
    create: true
    mode: u=rw
    state: present
    regexp: "{{ key_id.stdout }}"
    line: "{{ authorized_key }}"
