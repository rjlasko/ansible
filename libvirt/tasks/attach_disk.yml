---
## --------------------------------- ##
## Attach disk to a VM configuration ##
## --------------------------------- ##

- name: build attach-disk base command
  set_fact:
    virt_attach: "virsh attach-disk {{ libvirt_vm.name | mandatory }} {{ libvirt_disk.path | mandatory }} {{ libvirt_disk.target_dev | mandatory }}"

- name: add target_bus to base command
  when: libvirt_disk.target_bus is defined
  set_fact:
    virt_attach: "{{ virt_attach }} --targetbus {{ libvirt_disk.target_bus }}"

- name: stat the path to determine if it is a device or file
  stat:
    path: "{{ libvirt_disk.path }}"
    follow: true
    get_checksum: false
  register: libvirt_disk_path_stat

- name: if file, handle as per file type
  when: libvirt_disk_path_stat.stat.isreg and not libvirt_disk_path_stat.stat.islnk
  set_fact:
    virt_attach: "{{ virt_attach }} --driver qemu --subdriver {{ libvirt_disk.path.split('.') | last }}"

- name: add type to base command
  when: libvirt_disk.iothread is defined
  set_fact:
    virt_attach: "{{ virt_attach }} --iothread {{ libvirt_disk.iothread }}"

- name: add cache to base comand
  when: libvirt_disk.cache is defined
  set_fact:
    virt_attach: "{{ virt_attach }} --cache {{ libvirt_disk.cache }}"

- name: add io to base command
  when: libvirt_disk.io is defined
  set_fact:
    virt_attach: "{{ virt_attach }} --io {{ libvirt_disk.io }}"

- name: add serial to base command
  when: libvirt_disk.serial is defined
  set_fact:
    virt_attach: "{{ virt_attach }} --serial {{ libvirt_disk.serial }}"

- name: "attach disk to {{ libvirt_vm.name }}"
  command: "{{ virt_attach }} --config"
