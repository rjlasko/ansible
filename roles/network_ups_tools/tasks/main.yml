---
## --------------------------------------------------------------------------- ##
## This script seeks to automate the installation of a Network UPS Tools (NUT) ##
## --------------------------------------------------------------------------- ##
# XXX: With inspiration from - https://github.com/ykuksenko/ansible.nut

# TODO: send emails on relevant status changes
# https://unix.stackexchange.com/questions/164788/run-various-shell-commands-when-nut-reports-a-low-ups-battery


- when: nut.mode != "standalone" and nut.mode != "netclient"
  ansible.builtin.fail:
    msg: "Only supports 'standalone' and 'netclient' modes of operation."

- ansible.builtin.set_fact:
    nut_default_password: "{{ 9999999999999999999999 | random | to_uuid }}"

- when: nut.mode == "standalone"
  ansible.builtin.set_fact:
    nut_monitor_mode: "master"

- when: nut.mode == "netclient"
  ansible.builtin.set_fact:
    nut_monitor_name: "{{ nut.upsname | mandatory }}@{{ nut.server | mandatory }}"
    nut_monitor_mode: "slave"

- ansible.builtin.package:
    name: nut
    state: present

- name: nut.conf
  ansible.builtin.lineinfile:
    dest: "{{ nut_config_path }}/nut.conf"
    state: present
    regexp: '^MODE'
    line: "MODE={{ nut.mode }}"

- when: nut.mode == "standalone"
  ansible.builtin.include_tasks: server.yml

- when: nut.mode == "netclient" or nut.mode == "standalone"
  ansible.builtin.include_tasks: monitor.yml

- name: check ups connection
  ansible.builtin.command: "upsc {{ nut_monitor_name }}"
  register: upsc_out

- name: display ups info
  ansible.builtin.debug:
    msg: "{{ upsc_out.stdout_lines }}"
