---
## -------------------------------------------------------- ##
## Adds a user with permissions to build a package from AUR ##
## -------------------------------------------------------- ##

# pamac, and other AUR helpers require that packages be built not as root
# this means that a user must run pamac, and in a way that does not require login
# we should have a dedicated user for this:
# https://wiki.archlinux.org/index.php/Ansible#AUR
# https://github.com/kewlfft/ansible-aur#create-the-aur_builder-user

- name: add custom sudoer file
  lineinfile:
    path: /etc/sudoers.d/aur_builder-pacman-sudoer
    state: present
    create: true
    mode: u=r,g=r,o-rwx
    owner: root
    group: root
    regexp: '^.*aur_builder'
    line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    validate: visudo -cf %s
  notify:
    - cleanup aur_builder

- name: always trigger cleanup
  tempfile:
  notify:
    - cleanup aur_builder

# but we need to ensure that this user exists solely for the duration of roles that need it
# before roles - dependencies
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#role-dependencies
# after roles - notify (but the bummer is that this happens on change, so maybe the dependency needs to notify as well)
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#handlers-running-operations-on-change
